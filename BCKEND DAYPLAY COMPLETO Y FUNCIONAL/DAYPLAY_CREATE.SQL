CREATE DATABASE IF NOT EXISTS DAYPLAY;

USE DAYPLAY;

CREATE TABLE PERSON (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    NICKNAME VARCHAR(50) NOT NULL UNIQUE,
    PASSWORD_HASH VARCHAR(255) NOT NULL,
    EMAIL VARCHAR(100) NOT NULL UNIQUE,
    REGISTRATION_DATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ACTIVE TINYINT(1) NOT NULL DEFAULT 1,
    PERSON_TYPE ENUM('USER','ADMIN') NOT NULL
);

CREATE TABLE USER_PLAN (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    PLAN_TYPE ENUM('BASIC', 'PREMIUM') NOT NULL,
    ACTIVE TINYINT DEFAULT 0
);

CREATE TABLE APP_USER (
    PERSON_ID INT UNSIGNED PRIMARY KEY,
    SUBSCRIPTION_DATE DATETIME DEFAULT CURRENT_TIMESTAMP,
    PLAN_ID INT UNSIGNED,
    FOREIGN KEY (PLAN_ID) REFERENCES USER_PLAN(ID) ON DELETE CASCADE,
    FOREIGN KEY (PERSON_ID) REFERENCES PERSON(ID) ON DELETE CASCADE
);

CREATE TABLE ADMIN (
    PERSON_ID INT UNSIGNED PRIMARY KEY,
    DEPARTMENT ENUM('GAME','PAYMENT','EVENT','NOTIF') NOT NULL,
    ADMIN_TYPE ENUM('GAME_ADMIN','PAYMENT_ADMIN','EVENT_ADMIN','NOTIF_ADMIN') NOT NULL,
    PERMISSIONS JSON,
    FOREIGN KEY (PERSON_ID) REFERENCES PERSON(ID) ON DELETE CASCADE
);

CREATE TABLE USER_PENDING (
    PERSON_ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    FOREIGN KEY(PERSON_ID) REFERENCES APP_USER(PERSON_ID) ON DELETE CASCADE
);

CREATE TABLE BANK_ENTITY (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    NAME VARCHAR(100) NOT NULL,
    ENTITY_CODE VARCHAR(10) NOT NULL UNIQUE,
    ADDRESS VARCHAR(255),
    PHONE VARCHAR(20),
    CREATION_DATE DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE BANK_CARD (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    TOKEN VARCHAR(255) NOT NULL UNIQUE,
    LAST4 CHAR(4) NOT NULL,
    BRAND VARCHAR(30),
    BIN VARCHAR(8),
    EXPIRY_MONTH TINYINT,
    EXPIRY_YEAR SMALLINT,
    APPROX_BALANCE DECIMAL(10,2),
    IS_ACTIVE TINYINT(1) DEFAULT 1,
    BANK_ENTITY_ID INT UNSIGNED,
    USER_ID INT UNSIGNED NOT NULL,
    CREATION_DATE DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (BANK_ENTITY_ID) REFERENCES BANK_ENTITY(ID),
    FOREIGN KEY (USER_ID) REFERENCES APP_USER(PERSON_ID) ON DELETE CASCADE
);

CREATE TABLE GAME (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    NAME VARCHAR(50) NOT NULL UNIQUE,
    DESCRIPTION VARCHAR(255) NOT NULL,
    URL VARCHAR(255) NOT NULL UNIQUE
);

CREATE TABLE GAME_WORD (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    GAME_ID INT UNSIGNED NOT NULL,
    WORD VARCHAR(50) NOT NULL,
    LANGUAGE CHAR(2) DEFAULT 'ES',
    ACTIVE TINYINT(1) DEFAULT 1,
    CREATION_DATE DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (GAME_ID) REFERENCES GAME(ID),
    UNIQUE(GAME_ID, WORD)
);

CREATE TABLE MATH_OPERATION(
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    OPERATION VARCHAR(20) NOT NULL,
    RESULT VARCHAR(20) NOT NULL,
    GAME_ID INT UNSIGNED,
    FOREIGN KEY(GAME_ID) REFERENCES GAME(ID)
);

CREATE TABLE MATH_OPTION(
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    OPTION_VALUE VARCHAR(5) NOT NULL UNIQUE,
    OPERATION_ID INT UNSIGNED,
    FOREIGN KEY(OPERATION_ID) REFERENCES MATH_OPERATION(ID)
);

CREATE TABLE GAME_MATCH (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    USER_ID INT UNSIGNED NOT NULL,
    GAME_ID INT UNSIGNED NOT NULL,
    DATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    SCORE INT NOT NULL,
    EXTRA_DATA JSON,
    FOREIGN KEY (USER_ID) REFERENCES APP_USER(PERSON_ID),
    FOREIGN KEY (GAME_ID) REFERENCES GAME(ID)
);

CREATE TABLE DAILY_GAME_REWARD (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    USER_ID INT UNSIGNED NOT NULL,
    REWARD_DATE DATE NOT NULL,
    TOTAL_SCORE INT NOT NULL,
    CREATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (USER_ID) REFERENCES APP_USER(PERSON_ID) ON DELETE CASCADE,
    UNIQUE (USER_ID, REWARD_DATE)
);

CREATE TABLE STREAK (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    USER_ID INT UNSIGNED NOT NULL,
    GAME_ID INT UNSIGNED NOT NULL,
    CURRENT_STREAK INT NOT NULL DEFAULT 0,
    LAST_DATE DATE NOT NULL,
    UPDATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (USER_ID) REFERENCES APP_USER(PERSON_ID),
    FOREIGN KEY (GAME_ID) REFERENCES GAME(ID),
    UNIQUE(USER_ID, GAME_ID)
);

CREATE TABLE LEADERBOARD (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    USER_ID INT UNSIGNED NOT NULL,
    GAME_ID INT UNSIGNED NOT NULL,
    TOTAL_POINTS INT NOT NULL DEFAULT 0,
    LAST_UPDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (USER_ID) REFERENCES APP_USER(PERSON_ID),
    FOREIGN KEY (GAME_ID) REFERENCES GAME(ID),
    UNIQUE(USER_ID, GAME_ID)
);

CREATE TABLE PAYMENT (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    USER_ID INT UNSIGNED NOT NULL,
    AMOUNT DECIMAL(8,2) NOT NULL,
    DATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PAYMENT_METHOD VARCHAR(50) NOT NULL,
    TRANSACTION_ID VARCHAR(100),
    FOREIGN KEY (USER_ID) REFERENCES APP_USER(PERSON_ID)
);

CREATE TABLE PAYMENT_TRACE (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    PAYMENT_ID INT UNSIGNED NOT NULL,
    TRACE_DATE DATETIME DEFAULT CURRENT_TIMESTAMP,
    ACTION VARCHAR(50) NOT NULL,
    NOTES TEXT,
    UPDATED_BY INT UNSIGNED,
    FOREIGN KEY (PAYMENT_ID) REFERENCES PAYMENT(ID) ON DELETE CASCADE,
    FOREIGN KEY (UPDATED_BY) REFERENCES ADMIN(PERSON_ID)
);

CREATE TABLE NOTIFICATION (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    USER_ID INT UNSIGNED NOT NULL,
    TYPE VARCHAR(50) NOT NULL,
    TITLE VARCHAR(100),
    MESSAGE TEXT NOT NULL,
    SENT_DATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY INT UNSIGNED,
    FOREIGN KEY (USER_ID) REFERENCES APP_USER(PERSON_ID) ON DELETE CASCADE,
    FOREIGN KEY (CREATED_BY) REFERENCES ADMIN(PERSON_ID)
);

CREATE TABLE STORY (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    TITLE VARCHAR(100) NOT NULL,
    MONTH_YEAR CHAR(7) NOT NULL UNIQUE,
    DESCRIPTION TEXT,
    ACTIVE TINYINT(1) NOT NULL DEFAULT 1,
    CREATION_DATE DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE CHAPTER (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    STORY_ID INT UNSIGNED NOT NULL,
    DAY_NUMBER TINYINT NOT NULL,
    TITLE VARCHAR(100) NOT NULL,
    CONTENT TEXT NOT NULL,
    UNLOCK_CONDITION VARCHAR(255) DEFAULT 'Win 4 games',
    FOREIGN KEY (STORY_ID) REFERENCES STORY(ID),
    UNIQUE (STORY_ID, DAY_NUMBER)
);

CREATE TABLE STORY_ACCESS (
    ID INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    STORY_ID INT UNSIGNED NOT NULL,
    USER_ID INT UNSIGNED NOT NULL,
    GRANTED_BY INT UNSIGNED NOT NULL,
    ACCESS_GRANTED TINYINT(1) NOT NULL DEFAULT 1,
    GRANT_DATE DATETIME DEFAULT CURRENT_TIMESTAMP,
    REVOKE_DATE DATETIME NULL,
    NOTES VARCHAR(255),
    FOREIGN KEY (STORY_ID) REFERENCES STORY(ID),
    FOREIGN KEY (USER_ID) REFERENCES APP_USER(PERSON_ID),
    FOREIGN KEY (GRANTED_BY) REFERENCES ADMIN(PERSON_ID),
    UNIQUE(USER_ID, STORY_ID)
);

CREATE TABLE SYSTEM_EVENT (
    ID BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    ADMIN_ID INT UNSIGNED NULL,
    USER_ID INT UNSIGNED NULL,
    EVENT_TYPE VARCHAR(100) NOT NULL,
    DESCRIPTION TEXT,
    CATEGORY ENUM('ADMIN','USER','SYSTEM') NOT NULL,
    EVENT_DATE DATETIME DEFAULT CURRENT_TIMESTAMP,
    IP_ADDRESS VARCHAR(45),
    FOREIGN KEY (ADMIN_ID) REFERENCES ADMIN(PERSON_ID),
    FOREIGN KEY (USER_ID) REFERENCES APP_USER(PERSON_ID)
);

CREATE TABLE USER_GAME(
    USER_ID INT UNSIGNED,
    GAME_ID INT UNSIGNED,
    ACTIVE TINYINT DEFAULT 1,
    PRIMARY KEY(USER_ID, GAME_ID),
    FOREIGN KEY (USER_ID) REFERENCES APP_USER(PERSON_ID),
    FOREIGN KEY (GAME_ID) REFERENCES GAME(ID)
);
